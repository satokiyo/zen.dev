---
title: "makefileã®æŒ™å‹•ã§ãƒãƒã£ãŸã¨ãã®ãƒ¡ãƒ¢"
emoji: "ğŸ“–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [makefile]
published: true
---

# ã¯ã˜ã‚ã«

## make ã¨ã¯ï¼Ÿ

UNIX ã®ã‚·ã‚§ãƒ«ãŒå®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã®ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã€‚

C/C++ã‚’ gcc ã¨ã‹ã§é–‹ç™ºã™ã‚‹ã¨ãã«ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ã‚ˆãä½¿ã†ã€‚ãƒ“ãƒ«ãƒ‰ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã¯æœ€çµ‚çš„ãªå®Ÿè¡Œå½¢å¼ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚„.o ãªã©ã®ä¸­é–“ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®šã—ã€makefile ã«ã¯ãƒ•ã‚¡ã‚¤ãƒ«é–“ã®ä¾å­˜é–¢ä¿‚ã‚’å®šç¾©ã™ã‚‹ã€‚ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã« make ãŒãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰æ›´æ–°æ™‚åˆ»ã‚’èª¿ã¹ã€å†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒå¿…è¦ãªã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ã‚³ãƒãƒ³ãƒ‰ã ã‘ç”Ÿæˆã—ã¦ãã‚Œã‚‹ã€‚

Python ã§ä½¿ã†å ´åˆã€ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼ã¨ã—ã¦ä½¿ã†å ´åˆãŒã»ã¨ã‚“ã©ã¨æ€ã†ã€‚ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¯ãƒ•ã‚¡ã‚¤ãƒ«åã§ãªãã€é©å½“ãªåå‰ã‚’ã¤ã‘ã¦ãƒ€ãƒŸãƒ¼ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã—ã€ä¾å­˜é–¢ä¿‚ã®ã‚ã‚‹ãƒ€ãƒŸãƒ¼ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã‚Œã‚‹ã€‚

:::message

ãƒ€ãƒŸãƒ¼ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã¨ã€make ã¯å®Ÿè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã®ã§ã€`.PHONY` ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã—ã¦æ˜ç¤ºã—ã¦ã‚¹ã‚­ãƒƒãƒ—ã‚’å›é¿ã™ã‚‹ã€‚

:::

## makefile ã®ãƒã‚¯ãƒ­å¤‰æ•°

makefile å†…ã§ä½¿ã‚ã‚Œã‚‹å¤‰æ•°ã«ã¯ã„ãã¤ã‹ç¨®é¡ãŒã‚ã‚Šã€ä»¥ä¸‹ã®ã‚ˆã†ãªå„ªå…ˆé †ä½ãŒã‚ã‚‹ã€‚

ãƒã‚¯ãƒ­å¤‰æ•°å‚ç…§ã®å„ªå…ˆé †ä½(é«˜ã„é †)

1. å®Ÿè¡Œæ™‚ã«æ¸¡ã™å¤‰æ•°
2. makefile å†…ã§å®šç¾©ã•ã‚ŒãŸãƒã‚¯ãƒ­å¤‰æ•°
3. ç’°å¢ƒå¤‰æ•°
4. make ã®å®šç¾©æ¸ˆã¿ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒã‚¯ãƒ­

â€» make -e ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§èµ·å‹•ã™ã‚‹ã¨ 2 ã¨ 3 ãŒé€†è»¢ã™ã‚‹

# ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆï¼‘ï¼šmakefile å†…ã§å®šç¾©ã™ã‚‹ãƒã‚¯ãƒ­å¤‰æ•°

ä¸Šè¨˜ã€Œ2. makefile å†…ã§å®šç¾©ã•ã‚ŒãŸãƒã‚¯ãƒ­å¤‰æ•°ã€ã«é–¢ã—ã¦ã€ãƒã‚¯ãƒ­å¤‰æ•°ã®å®šç¾©ã¯ makefile å†…ã§ä¸Šã‹ã‚‰é †ã«ãªã•ã‚Œã‚‹ãŒã€å®šç¾©æ–¹æ³•ã«ã‚ˆã‚Šè©•ä¾¡å€¤ãŒç•°ãªã‚‹ã€‚

- Simple assignmentÂ `:=`
  ãƒã‚¯ãƒ­å¤‰æ•°ã®æœ€å¾Œã®å®šç¾©æ™‚ã®å€¤ã‚’è©•ä¾¡ã€‚
  åŒã˜ãƒã‚¯ãƒ­å¤‰æ•°ã«è¤‡æ•°å›å‰²ã‚Šå½“ã¦ãŸå ´åˆã€makefile ã§ä¸‹ã®æ–¹ã«æ›¸ã„ãŸå€¤ã«è©•ä¾¡ã•ã‚Œã‚‹ã€‚

  ```makefile
  X := first # 1å›ç›®å®šç¾©
  Y := ${X} # 1å›ç›®å®šç¾©
  X := second # 2å›ç›®å®šç¾©

  target:
  	@echo ${X} # second (æœ€çµ‚å®šç¾©å€¤)
  	@echo ${Y} # first (æœ€çµ‚å®šç¾©å€¤)
  ```

  :::message
  Simple assignment ã§ã®å¤‰æ•°å®šç¾©ãŒå¤šããªã‚‹ã¨ make ã‚³ãƒãƒ³ãƒ‰ã®ã‚¿ãƒ–è£œå®ŒãŒé…ããªã£ã¦ã„ãã€‚ã€‚ã‚¿ãƒ–è£œå®Œã™ã‚‹ã¨ãã«ã‚‚æ¯å›å¤‰æ•°ã®å‰²ã‚Šå½“ã¦ãŒã•ã‚Œã‚‹ã½ã„ã€‚ä»¥ä¸‹ã® Recursive assignment ã¨ Conditional assignment ã§ã¯ã€ãã®ã‚ˆã†ãªæŒ™å‹•ã«ã¯ãªã‚‰ãªã‹ã£ãŸã€‚
  :::

- Recursive assignmentÂ `=`

  ãƒã‚¯ãƒ­å¤‰æ•°ã®å‚ç…§æ™‚ã«å€¤ã‚’è©•ä¾¡ã€‚

  ```makefile
  X = first
  Y = ${X}
  X = second

  target:
  	@echo ${X} # second (å‚ç…§æ™‚ã®è©•ä¾¡å€¤)
  	@echo ${Y} # second (å‚ç…§æ™‚ã®è©•ä¾¡å€¤)
  ```

- Conditional assignmentÂ `?=`
  ãƒã‚¯ãƒ­å¤‰æ•°ã®æœ€åˆã®å®šç¾©æ™‚ã®å€¤ã‚’è©•ä¾¡ã€‚

  ```makefile
  X ?= first # 1å›ç›®å®šç¾©
  Y ?= ${X} # 1å›ç›®å®šç¾©
  X ?= second # 2å›ç›®å®šç¾©

  target:
  	@echo ${X} # first (ä¸€å›ç›®å®šç¾©å€¤)
  	@echo ${Y} # first (ä¸€å›ç›®å®šç¾©å€¤)
  ```

# ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆï¼’ï¼šmake ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ

make ã¯ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ã‚³ãƒãƒ³ãƒ‰è¡Œã®å„è¡Œã‚’ã€ãã‚Œãã‚Œåˆ¥ã®ã‚·ã‚§ãƒ«ã«æ¸¡ã—ã¦å®Ÿè¡Œã•ã›ã‚‹ã€‚ä¸Šã‹ã‚‰é †ç•ªã«ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã—ã€å„ã‚·ã‚§ãƒ«ã§ã®å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã¸ç§»ã‚‹ã€‚ãŸã ã—ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã¨ã—ã¦èµ·å‹•ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã®å ´åˆã¯ã€ã™ãã«æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã¸ç§»ã‚‹ã€‚

:::message

make ãŒå®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰ 0 ä»¥å¤–ã®(ã‚¨ãƒ©ãƒ¼)çµ‚äº†ã‚³ãƒ¼ãƒ‰ãŒè¿”ã£ã¦ããŸå ´åˆã€make ã¯æ§‹ç¯‰é€”ä¸­ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’å…¨ã¦æ¶ˆå»ã—ã¦çµ‚äº†ã™ã‚‹ã€‚-i ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã‚‹ã‹ã€.IGNORE: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’è¨˜è¿°ã™ã‚‹ã‹ã€ã‚³ãƒãƒ³ãƒ‰ã®å‰ã«ãƒã‚¤ãƒ•ãƒ³-ã‚’ã¤ã‘ã‚‹ã“ã¨ã§ã€ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ç„¡è¦–ã—ã¦å‡¦ç†ã‚’ç¶™ç¶šã™ã‚‹ã€‚

:::

- æ”¹è¡ŒãŒã‚ã‚‹å ´åˆã®æŒ¯ã‚‹èˆã„
  ä»¥ä¸‹ã¯æ”¹è¡Œã•ã‚Œã¦ã„ã‚‹ã®ã§ã€make ã¯å„è¡Œã”ã¨ã«ã‚·ã‚§ãƒ«ã‚’èµ·å‹•ã™ã‚‹ã€‚
  ```makefile
  cd dir;
  rm *
  ```
  åŒã˜ã‚·ã‚§ãƒ«ã§å®Ÿè¡Œã™ã‚‹ã«ã¯ã€ä¸€è¡Œã§æ›¸ãã‹ã‚»ãƒŸã‚³ãƒ­ãƒ³ã¨ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã§æ”¹è¡Œã‚’è§£é‡ˆã™ã‚‹ã“ã¨ã‚’é˜²ãã€‚make ãŒè¤‡æ•°è¡Œã‚’æœ‰åŠ¹ãªã‚³ãƒãƒ³ãƒ‰ã¨ã—ã¦ã¾ã¨ã‚ã¦ã€ä¸€åº¦ã«ã‚·ã‚§ãƒ«ã«æ¸¡ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
  ä¸€è¡Œã§æ›¸ãã‹
  ```makefile
  target:
  	cd dir; rm *
  ```
  ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã§è¤‡æ•°è¡Œã‚’ã¾ã¨ã‚ã¦æ›¸ã
  ```makefile
  target:
  	cd dir;  \
  	rm *
  ```
  è¤‡æ•°è¡Œã®ã‚·ã‚§ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æ›¸ã
  ```makefile
  target:
  	if \
  		condition; \
  	then \
  		command1; \
  		command2; \
  	else \
  		command1; \
  		command2; \
  	fi
  ```
- ã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰å†…ã§ã®å¤‰æ•°å‚ç…§ã¯$$ã¨$ã®é•ã„ã«æ³¨æ„
  ãƒã‚¯ãƒ­å¤‰æ•°ã®å‚ç…§ã¯${}ã§ã€ã‚·ã‚§ãƒ«å¤‰æ•°ã®å‚ç…§ã¯$${}ã§å‚ç…§ã™ã‚‹ã€‚$ã¯ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ–‡å­—ã®ã‚ˆã†ã«ä½¿ã‚ã‚Œã€æœ€åˆã®$ã¯ make ãŒãƒã‚¯ãƒ­å‚ç…§ã®ãŸã‚ã«å–ã‚Šé™¤ãã€${}ãŒã‚·ã‚§ãƒ«ã«æ¸¡ã•ã‚Œã‚‹ã€‚ã‚³ãƒãƒ³ãƒ‰å†…ã§æ­£è¦è¡¨ç¾ã®$ã‚’ä½¿ã†ã¨ãã«ã‚‚ã€$$ã¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

  ```makefile
  FILE1 := foo.txt
  FILE2 := bar.txt

  echo:
  	@echo ${FILE1} # foo.txt
  	@echo ${FILE2} # bar.txt

  log:
  	for i in ${FILE1} ${FILE2}; do \
  		cat $$i ; \
  		grep -e ".*pattern$$" $$i >> logfile; \
  		rm $$i; \
  	done

  ```

# ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆï¼“ï¼šmakefile ã§æ¡ä»¶åˆ†å²ã™ã‚‹

gcloud ã‚³ãƒãƒ³ãƒ‰ã§ GCP ã®ãƒªã‚½ãƒ¼ã‚¹ã®å­˜åœ¨ã®æœ‰ç„¡ã«ã‚ˆã£ã¦ç•°ãªã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã‹ã£ãŸã€‚

- ãƒãƒã‚Šï¼‘

  gcloud ã‚³ãƒãƒ³ãƒ‰å‡ºåŠ›ã®çµæœã‚’ãƒã‚¯ãƒ­å¤‰æ•°ã«ä»£å…¥ã—ã¦ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰å†…ã§å‚ç…§ã—ã‚ˆã†ã¨ã—ãŸã¨ã“ã‚ã€make ã‚’èµ·å‹•ã™ã‚‹ã¨ãã«ã‚¿ãƒ–è£œå®ŒãŒé…ããªã‚‹ã€‚

  â‡’ ã€Œãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆï¼‘ï¼šmakefile å†…ã§å®šç¾©ã™ã‚‹ãƒã‚¯ãƒ­å¤‰æ•°ã€ã§æ›¸ã„ãŸã€å¤‰æ•°å®šç¾©ã®ç¨®é¡ã®å•é¡Œã ã£ãŸã€‚Simple assignment ã‚’å¤šç”¨ã™ã‚‹ã¨ã€ã©ã†ã‚‚ã‚¿ãƒ–è£œå®ŒãŒé…ããªã‚‹ã€‚

  â‡’ Recursive assignment ã«ã™ã‚‹ã“ã¨ã§ã€å•é¡Œã¯è§£æ¶ˆã€‚ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã«å¤‰æ•°ã‚’è©•ä¾¡ã—ã¦ãã‚Œã‚‹ãŸã‚ã¨æ€ã‚ã‚Œã‚‹ã€‚

  â€» ã‚‚ã—ãã¯ make ã®ãƒã‚¯ãƒ­å¤‰æ•°ã§ã¯ãªãã€ã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰å†…ã§ eval ã§ã‚·ã‚§ãƒ«å¤‰æ•°ã«å‰²ã‚Šå½“ã¦ã¦ã‚‚ã„ã„ãŒã€ã¡ã‚‡ã£ã¨è¦‹ã«ãããªã‚‹ã€‚ã€‚

  ```makefile
  NAME:= # GCP resource name

  target:
  ifndef NAME
  	$(error argument expected)
  endif
  	$(eval COUNT:=$(shell gcloud command get ${NAME} --format="value(name)" --filter="name ~ ^.*${NAME}$$" | wc -l))
  	@if [ ${COUNT} ... ] ; ...
  ```

- ãƒãƒã‚Š 2

  `ifdef`, `ifndef`ã¨ã„ã£ãŸ make ã®æ¡ä»¶åˆ†å²ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ä½¿ã†å ´åˆã€æœ€ä½é™ã®æ©Ÿèƒ½ã—ã‹ãªãè¤‡æ•°æ¡ä»¶ã¨ã‹å¤§å°æ¯”è¼ƒã¨ã‹ãŒé¢å€’ã€‚ã€‚

  â‡’ ã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰å†…ã§ test ã‚³ãƒãƒ³ãƒ‰ã§åˆ†å²ã•ã›ãŸæ–¹ãŒæ¥½

  ```makefile
  NAME:= # GCP resource name
  COUNT=$(shell gcloud command get ${NAME} --format="value(name)" --filter="name ~ ^.*${NAME}$$" | wc -l) # resource count

  target:
  ifndef NAME
  	$(error argument expected)
  endif
  	@if [ ${COUNT} -eq 0 ]; then \
  		gcloud create ...;
  	elif [ ${COUNT} -gt 0 ]; then \
  		gcloud update ...;
  	else \
  		echo no resources found!!; \
  	fi
  ```

- ãƒãƒãƒªï¼“
  ä¸Šè¨˜ã®ã‚ˆã†ã« test ã‚³ãƒãƒ³ãƒ‰ã§åˆ†å²ã•ã›ãŸãŒã€gcloud ã‚³ãƒãƒ³ãƒ‰ã® create or update ä»¥ä¸‹ã¯åŒã˜ãªã®ã§ã€é–¢æ•°ã®å‘¼ã³å‡ºã—ã«ã—ã¦å‡¦ç†ã‚’ã¾ã¨ã‚ãŸã‹ã£ãŸã€‚

  â‡’ å†å¸° make ã‹ãƒã‚¯ãƒ­ã§è§£æ±º
  make å®Ÿè¡Œæ™‚ã«æ¸¡ã™å¤‰æ•°ãŒæœ€ã‚‚å„ªå…ˆé †ä½ãŒé«˜ã„ã®ã§ã€makefile å†…ã‚„ç’°å¢ƒå¤‰æ•°ã§å®šç¾©ã—ãŸå¤‰æ•°ã‚’ä¸Šæ›¸ãã—ã¦å®Ÿè¡Œã—ãŸã„å ´åˆãªã©ã¯ã“ã¡ã‚‰ãŒå‘ã„ã¦ã„ã‚‹ã€‚

  ```makefile
  NAME:= # GCP resource name
  COUNT=$(shell gcloud command get ${NAME} --format="value(name)" --filter="name ~ ^.*${NAME}$$" | wc -l) # resource count

  target:
  ifndef NAME
  	$(error argument expected)
  endif
  	@if [ ${COUNT} -eq 0 ]; then \
  		echo create resource!!; \
  		${MAKE} target2 "param=create"; \
  	elif [ ${COUNT} -gt 0 ]; then \
  		echo update resource!!; \
  		${MAKE} target2 "param=update"; \
  	else \
  		echo no resources found!!; \
  	fi

  target2:
  	gcloud command ${param} \
  	--option ... \
  	--option ... \
  	...
  ```

  ãƒã‚¯ãƒ­ã‚’`define`,`call`ã™ã‚‹æ–¹æ³•ã§ã‚‚å‡ºæ¥ã‚‹ã€‚

  ```makefile
  NAME:= # GCP resource name
  COUNT=$(shell gcloud command get ${NAME} --format="value(name)" --filter="name ~ ^.*${NAME}$$" | wc -l) # resource count

  target:
  ifndef NAME
  	$(error argument expected)
  endif
  	@if [ ${COUNT} -eq 0 ]; then \
  		echo create resource!!; \
  		$(call func,create) \
  	elif [ ${COUNT} -gt 0 ]; then \
  		echo update resource!!; \
  		$(call func,update) \
  	else \
  		echo no resources found!!; \
  	fi

  define func:
  	gcloud command $1 \
  	--option ... \
  	--option ... \
  	...
  ```

  :::message
  ãƒã‚¯ãƒ­ã®å‘¼ã³å‡ºã—ã§ã€`$(call func,param);`ã®ã‚ˆã†ã«ã€ã‚»ãƒŸã‚³ãƒ­ãƒ³`;`ã‚’ã¤ã‘ã‚‹ã¨ä¸Šæ‰‹ãã„ã‹ãªã‹ã£ãŸã€‚ã“ã®å ´åˆã¯`;`ã¯ä¸è¦ã‚‰ã—ã„ã€‚
  :::
